<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="closeEditor()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ editorTitle }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="exportVideo()">
        <ion-icon name="save"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="editor-container">
    <!-- Canvas Container -->
    <div #canvasContainer class="canvas-container">
      <!-- Trim Rectangle Overlay -->
      <div *ngIf="isTrimMode" 
           class="trim-rectangle"
           [style.left.px]="trimRect.x"
           [style.top.px]="trimRect.y"
           [style.width.px]="trimRect.width"
           [style.height.px]="trimRect.height">
        <div class="trim-handle top-left" (mousedown)="startResize($event, 'top-left')" (touchstart)="startResize($event, 'top-left')"></div>
        <div class="trim-handle top-right" (mousedown)="startResize($event, 'top-right')" (touchstart)="startResize($event, 'top-right')"></div>
        <div class="trim-handle bottom-left" (mousedown)="startResize($event, 'bottom-left')" (touchstart)="startResize($event, 'bottom-left')"></div>
        <div class="trim-handle bottom-right" (mousedown)="startResize($event, 'bottom-right')" (touchstart)="startResize($event, 'bottom-right')"></div>
      </div>

      <!-- Template image preview in the top corner -->
      <div class="template-video-preview"
           *ngIf="selectedTemplateImage"
           [style.top.px]="templateImagePosition.top"
           [style.left.px]="templateImagePosition.left"
           (mousedown)="startDrag($event)"
           (touchstart)="startDrag($event)">
        <img [src]="selectedTemplateImage" alt="Template Preview" />
      </div>

      <div *ngFor="let layer of layers" 
           class="video-layer"
           [class.selected]="layer.isSelected"
           [class.dragging]="isDraggingLayer && selectedLayerId === layer.id"
           [class.resizing]="isResizing && selectedLayerId === layer.id"
           [style.z-index]="layer.zIndex"
           [style.left.px]="layer.position.x"
           [style.top.px]="layer.position.y"
           [style.width.px]="layer.size.width"
           [style.height.px]="layer.size.height"
           [style.opacity]="layer.opacity"
           (mousedown)="startDragLayer($event, layer.id)"
           (touchstart)="startDragLayer($event, layer.id)">
        
        <video *ngIf="layer.videoUrl" 
               [id]="'video-' + layer.id"
               [src]="layer.videoUrl"
               class="layer-video"
               [attr.currentTime]="layer.startTime"
               (timeupdate)="onTimeUpdate($event, layer)"
               disablePictureInPicture
               controlsList="nodownload nofullscreen"
               muted
               playsinline
               preload="auto">
        </video>
        
        <!-- Resize Handles -->
        <div class="resize-handle top-left"
             (mousedown)="startResizeLayer($event, layer.id); $event.stopPropagation()"
             (touchstart)="startResizeLayer($event, layer.id); $event.stopPropagation()">
        </div>
        <div class="resize-handle top-right"
             (mousedown)="startResizeLayer($event, layer.id); $event.stopPropagation()"
             (touchstart)="startResizeLayer($event, layer.id); $event.stopPropagation()">
        </div>
        <div class="resize-handle bottom-left"
             (mousedown)="startResizeLayer($event, layer.id); $event.stopPropagation()"
             (touchstart)="startResizeLayer($event, layer.id); $event.stopPropagation()">
        </div>
        <div class="resize-handle bottom-right"
             (mousedown)="startResizeLayer($event, layer.id); $event.stopPropagation()"
             (touchstart)="startResizeLayer($event, layer.id); $event.stopPropagation()">
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="timeline-container">
      <div class="timeline-controls">
        <div class="main-controls">
          <ion-button fill="clear" (click)="togglePlay()">
            <ion-icon [name]="isPlaying ? 'pause' : 'play'"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="toggleTrimMode()" [color]="isTrimMode ? 'primary' : ''">
            <ion-icon name="cut-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="toggleOpacityPanel()">
            <ion-icon name="contrast-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" (click)="addNewLayer()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Global scrubbing hint -->
        <div class="global-scrubbing-hint">
          <ion-icon name="arrow-forward"></ion-icon>
          Drag the pink vertical line to scrub through video
          <ion-icon name="arrow-back"></ion-icon>
        </div>
      </div>

      <div class="timeline-tracks">
        <div *ngFor="let layer of layers" 
             class="timeline-track"
             [class.selected]="layer.isSelected"
             [class.moving-up]="layer.isMovingUp"
             [class.moving-down]="layer.isMovingDown"
             [attr.data-layer-id]="layer.id"
             (click)="selectLayer(layer.id)">
          
          <div class="track-label">
            <div class="layer-header">
              <span>Layer {{layer.zIndex + 1}}</span>
              <div class="layer-actions">
                <ion-button fill="clear" size="small" (click)="moveLayerUp(layer.id)" (mousedown)="$event.stopPropagation()">
                  <ion-icon name="arrow-up"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" (click)="moveLayerDown(layer.id)" (mousedown)="$event.stopPropagation()">
                  <ion-icon name="arrow-down"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" color="danger" (click)="deleteLayer(layer.id)" (mousedown)="$event.stopPropagation()">
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </div>
            <div class="layer-time-controls">
              <ion-input type="text" 
                        [value]="formatTime(layer.startTime)"
                        (ionChange)="setVideoStartTime(layer.id, $event.detail.value)"
                        label="Start Time"
                        labelPlacement="stacked"
                        [min]="0"
                        [max]="layer.duration"
                        class="time-input">
              </ion-input>
              <ion-input type="text"
                        [value]="formatTime(layer.endTime)"
                        (ionChange)="setVideoEndTime(layer.id, $event.detail.value)"
                        label="End Time"
                        labelPlacement="stacked"
                        [min]="layer.startTime"
                        [max]="layer.duration"
                        class="time-input">
              </ion-input>
              <div class="upload-button">
                <ion-button fill="outline" size="small" (click)="triggerFileUpload(layer.id)" (mousedown)="$event.stopPropagation()">
                  <ion-icon name="cloud-upload"></ion-icon>
                  Upload
                </ion-button>
                <input 
                  type="file" 
                  accept="video/*" 
                  [id]="'file-input-' + layer.id"
                  style="display: none"
                  (change)="onVideoFileSelected($event, layer.id)"
                >
              </div>
            </div>
          </div>

          <div class="track-content"
               [class]="getTrackContentClass()"
               (mousedown)="startTimelineLongPress($event)"
               (touchstart)="startTimelineLongPress($event)"
               (mouseup)="endTimelineLongPress()"
               (mouseleave)="endTimelineLongPress()"
               (touchend)="endTimelineLongPress()"
               (touchcancel)="endTimelineLongPress()"
               (click)="onPlayheadDrag($event, layer.id)">
            <div class="thumbnails-container">
              <div *ngFor="let thumbnail of layer.thumbnails; let i = index"
                   class="thumbnail">
                <img [src]="thumbnail" alt="Thumbnail">
              </div>
              <!-- Add timestamp labels -->
              <div *ngIf="layer.duration > 0" class="timeline-ticks">
                <span *ngFor="let thumbnail of layer.thumbnails; let i = index"
                      class="timeline-tick"
                      [style.left.%]="(i / layer.thumbnails.length) * 100">
                  {{ formatTime((i / layer.thumbnails.length) * layer.duration) }}
                </span>
              </div>
            </div>

            <div class="timeline-overlay">
              <div class="trim-handles">
                <div *ngIf="isTrimMode && layer.isSelected" 
                     class="trim-frame"
                     [style.left.px]="layer.trimFrameStart"
                     [style.width.px]="layer.trimFrameWidth">
                  <div class="trim-handle left"
                       (mousedown)="startTimelineTrim($event, 'start', layer.id)"
                       (touchstart)="startTimelineTrim($event, 'start', layer.id)">
                  </div>
                  <div class="trim-handle right"
                       (mousedown)="startTimelineTrim($event, 'end', layer.id)"
                       (touchstart)="startTimelineTrim($event, 'end', layer.id)">
                  </div>
                </div>

                <!-- Enhanced playhead with label -->
                <div class="playhead-container">
                  <div class="playhead"
                       [style.left.px]="getPlayheadPosition(layer)"
                       (mousedown)="startPlayheadDrag($event, layer.id)"
                       (touchstart)="startPlayheadDrag($event, layer.id)">
                    <!-- Display current time -->
                    <div class="playhead-label">{{ formatTime(getCurrentVideoTime(layer.id)) }}</div>
                  </div>
                </div>

                <!-- Add a visual indicator for scrubbing -->
                <div class="scrubber-hint">
                  Click or drag anywhere on timeline to scrub
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Opacity Panel -->
  <div class="opacity-panel" *ngIf="showOpacityPanel && selectedLayerId">
    <div class="panel-header">
      <h3>Opacity</h3>
      <ion-button fill="clear" size="small" (click)="toggleOpacityPanel()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>
    <div class="panel-content">
      <ion-range
        [value]="getSelectedLayerOpacity()"
        (ionChange)="handleOpacityChange($event)"
        min="0"
        max="100"
        step="1"
        [pin]="true"
        [snaps]="false">
        <ion-icon name="contrast-outline" slot="start"></ion-icon>
        <ion-icon name="contrast" slot="end"></ion-icon>
      </ion-range>
    </div>
  </div>
</ion-content>

<!-- Video Stitching Modal -->
<ion-modal #stitchingModal [isOpen]="isStitchingModalOpen">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Stitch Videos</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeStitchingModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-list>
        <ion-item *ngFor="let video of selectedVideos; let i = index">
          <ion-thumbnail slot="start">
            <video [src]="video.preview" style="width: 100%; height: 100%;"></video>
          </ion-thumbnail>
          <ion-label>
            <h2>Video {{i + 1}}</h2>
            <p>{{video.file.name}}</p>
          </ion-label>
          <ion-button slot="end" fill="clear" color="danger" (click)="removeVideo(i)">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item *ngIf="selectedVideos.length < 5">
          <ion-button expand="block" (click)="addVideo()">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Add Video
          </ion-button>
        </ion-item>
      </ion-list>

      <ion-button expand="block" 
                  [disabled]="selectedVideos.length < 2 || isStitching"
                  (click)="startStitching()">
        <ion-spinner *ngIf="isStitching"></ion-spinner>
        <span *ngIf="!isStitching">Stitch Videos</span>
      </ion-button>
    </ion-content>
  </ng-template>
</ion-modal>
